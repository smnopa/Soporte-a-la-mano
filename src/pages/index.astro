---
import Layout from '../layouts/Layout.astro';
import Form from '../components/Form.astro';
---

<Layout>
  <div class="min-h-screen bg-gray-100 py-6 flex flex-col justify-center sm:py-12">
    <div class="relative py-3 sm:max-w-xl sm:mx-auto">
      <div class="relative px-4 py-10 bg-white mx-8 md:mx-0 shadow rounded-3xl sm:p-10">
        <div class="max-w-md mx-auto">
            <!-- Logo -->
          <div class="flex items-center justify-center">
            <img src="/logoSena.png" alt="SENA Logo" class="h-16" />
          </div>
          <div class="divide-y divide-gray-200">
            <div class="py-8 text-base leading-6 space-y-4 text-gray-700 sm:text-lg sm:leading-7">
              <!-- Titulo -->
              <h1 class="text-2xl font-bold text-center mb-8">Soporte a la Mano</h1>
              <!-- Formulario -->
              <Form/>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import SignaturePad from 'signature_pad';
  import html2pdf from 'html2pdf.js';
  
  // Inicializar el pad de firma
  const canvas = document.getElementById('signaturePad');
  const signaturePad = new SignaturePad(canvas);
  
  // Limpiar firma
  document.getElementById('clearSignature').addEventListener('click', () => {
    signaturePad.clear();
  });
  
  // Generar n√∫mero de ticket autom√°ticamente
  function generateTicketNumber() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = String(now.getFullYear()).slice(-2);
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    return `${day}${month}${year}-${hours}:${minutes}`;
  }
  
  document.getElementById('ticketNumber').value = generateTicketNumber();
  
  // Almacenar las im√°genes como base64
  let uploadedImages = [];
  
  // Manejo de im√°genes
  document.getElementById('photos').addEventListener('change', function(e) {
    const container = document.getElementById('imageContainer');
    
    for (let file of e.target.files) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const imageData = e.target.result;
        uploadedImages.push(imageData);
        
        const div = document.createElement('div');
        div.className = 'relative';
        
        const img = document.createElement('img');
        img.src = imageData;
        img.className = 'h-20 w-20 object-cover rounded';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '√ó';
        deleteBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center';
        deleteBtn.onclick = function() {
          const index = uploadedImages.indexOf(imageData);
          if (index > -1) {
            uploadedImages.splice(index, 1);
          }
          div.remove();
        };
        
        div.appendChild(img);
        div.appendChild(deleteBtn);
        container.appendChild(div);
      };
      reader.readAsDataURL(file);
    }
  });
  
  // Manejo del formulario
  document.getElementById('supportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Crear el PDF
    const element = document.createElement('div');
  element.innerHTML = `
    <div style="padding: 40px; font-family: Arial, sans-serif; color: #000; font-size: 14px;">

      <!-- Logo y t√≠tulo -->
      <div style="text-align: center; margin-bottom: 10px;">
        <img src="/logoSena.png" style="height: 80px; display: block; margin: 0 auto;">
        <div style="font-size: 14px; margin-top: 5px; color: #00af00;">Soporte a la mano</div>
      </div>

      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 14px; margin-top: 5px;">Comprobante de Soporte T√©cnico del ID: ${document.getElementById('idSelector').value}</div>
      </div>

      <!-- Caso y Fecha -->
      <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <div><strong>Nro de Caso en MS:</strong> ${document.getElementById('caseNumber').value || 'Ninguno'}</div>
        <div><strong>Nro de Ticket / Fecha de atenci√≥n:</strong> ${document.getElementById('ticketNumber').value}</div>
      </div>

      <!-- Detalle del Soporte -->
      <p style="margin-bottom: 30px;">
        El Soporte <strong>${document.getElementById('supportName').value}</strong> con correo electr√≥nico 
        <strong><a href="mailto:${document.getElementById('supportEmail').value}">${document.getElementById('supportEmail').value}</a></strong>, 
        siendo el d√≠a y hora <strong>${document.getElementById('ticketNumber').value}</strong> atendi√≥ el 
        incidente:<strong> ${document.getElementById('issue').value}</strong>; 
        en el dispositivo: <strong>${document.getElementById('deviceType').value}</strong> con 
        serial o placa<strong> ${document.getElementById('serialNumber').value}</strong>, se brind√≥ la siguiente
        soluci√≥n: <strong>${document.getElementById('solution').value}.</strong>
      </p>

      <!-- Detalle del Usuario -->
      <p style="margin-bottom: 40px;">
        El Usuario <strong>${document.getElementById('userName').value}</strong> con correo electr√≥nico 
        <strong><a href="mailto:${document.getElementById('userEmail').value}">${document.getElementById('userEmail').value}</a></strong>, 
        <strong>${document.querySelector('input[name="conformity"]:checked').value === 'si' ? 'S√≠ est√° conforme' : 'No est√° conforme'}</strong>, con la atenci√≥n brindada.
      </p>

      <!-- Observaciones -->
      <div style="margin-bottom: 40px;">
        <strong>Observaci√≥n:</strong><br>
        ${document.getElementById('observations').value || 'Ninguna'}
      </div>

      <!-- Firma -->
      <div style="margin-bottom: 40px;">
        <strong>Visto bueno:</strong><br>
        <img src="${signaturePad.toDataURL()}" style="max-width: 250px; height: auto; margin-top: 10px;">
      </div>

      <!-- SALTO DE P√ÅGINA PARA LA SEGUNDA SECCI√ìN -->
      <div style="page-break-before: always;"></div>

      <strong style="font-size: 16px;">Evidencia Fotogr√°fica</strong>
      <div id="imagesWrapper" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 12px;"></div>
    </div>
  `;
  
const wrapper = element.querySelector('#imagesWrapper');

for (let i = 0; i < uploadedImages.length; i++) {
  const img = new Image();
  img.src = uploadedImages[i];

  await new Promise(resolve => {
    img.onload = () => {
      const isVertical = img.naturalHeight > img.naturalWidth;

      const div = document.createElement('div');
      div.style = `
        width: ${isVertical ? '48%' : '100%'};
        max-width: ${isVertical ? '48%' : '100%'};
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 4px;
      `;

      img.style = `
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
        object-fit: contain;
      `;

      div.appendChild(img);
      wrapper.appendChild(div);
      resolve();
    };
  });
}
    const opt = {
      margin: 1,
      filename: `reporte-${document.getElementById('serialNumber').value}-${document.getElementById('ticketNumber').value}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
  
    try {
  await html2pdf().set(opt).from(element).save();

  alert('Reporte PDF generado correctamente');

  const numero = document.getElementById('userNumber').value.trim().replace(/\D/g, '').slice(-10);
  const mensaje = encodeURIComponent("Hola, te env√≠o el reporte t√©cnico desde Soporte a la Mano üìã‚úÖ");

  // Mostramos bot√≥n flotante por si falla la redirecci√≥n autom√°tica
  const btn = document.createElement('button');
  btn.textContent = "Enviar por WhatsApp";
  btn.style = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 16px;
    background-color: #25D366;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    z-index: 9999;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  `;
  btn.onclick = () => {
    window.location.href = `https://wa.me/57${numero}?text=${mensaje}`;
  };
  document.body.appendChild(btn);

  // Intentar redirigir autom√°ticamente a WhatsApp despu√©s de un tiempo
  setTimeout(() => {
    window.location.href = `https://wa.me/57${numero}?text=${mensaje}`;
  }, 1500);

  // Limpieza de formulario
  this.reset();
  signaturePad.clear();
  document.getElementById('imageContainer').innerHTML = '';
  document.getElementById('ticketNumber').value = generateTicketNumber();
  uploadedImages = [];
} catch (error) {
  alert('Error al generar el PDF: ' + error.message);
}
  });
  </script>   

<style>
  input[type="text"],
  input[type="email"],
  textarea {
    @apply border-gray-300 rounded-md shadow-sm;
  }
  
  canvas {
    touch-action: none;
  }
</style>